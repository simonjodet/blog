<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
    "http://www.w3.org/TR/html4/loose.dtd">

<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Mixing up TDD, PHPUnit, Namespaces and Jenkins - Simon's Blog</title>
    <meta name="generator" content="Jekyll">
    <meta name="author" content="Simon Jodet">
    <link rel="stylesheet" href="/lib/bootstrap/bootstrap-1.1.1.min.css" type="text/css" charset="utf-8"/>
    <link rel="stylesheet" href="/lib/jquery.tweet.css" type="text/css" charset="utf-8"/>
    <link rel="stylesheet" href="/style/style.css" type="text/css" charset="utf-8"/>
</head>
<body>

    <div class="container">
        <div class="page-header">
            <h1>
                <a href="/" class="main-title" id="home">Simon's Blog</a><br/>
                <div class="twipsy below tooltips" id="home-tooltip"> 
                    <div class="twipsy-arrow"></div> 
                    <div class="twipsy-inner">Back to home page</div> 
                </div>
                <small>Not the most original blog name in the world</small>
            </h1>
        </div>
    <div>
    <div class="container page-header">
        <div class="row">
            <div class="span11 columns">
                <div class="page-header">
    <h3>
        Mixing up TDD, PHPUnit, Namespaces and Jenkins<br/>
        <small>Published on 22 Feb 2011</small>
    </h3>
</div>
<div>
    <p>Hi all,</p>

<p>First of all, if you&#8217;re not a PHP developer, don&#8217;t read this.</p>

<p>This post will be about my tries and misses with <a href='http://en.wikipedia.org/wiki/Test-driven_development'>TDD</a>. To make things harder, I&#8217;m adding into the mix <a href='http://www.phpunit.de/manual/3.6/en/index.html'>PHPUnit</a> (of which I have minimal knowledge), <a href='http://www.php.net/manual/en/language.namespaces.php'>namespaces</a> (because I&#8217;m also a JavaScript developer and I feel at home now) and <a href='http://jenkins-ci.org/'>Jenkins</a> (fka Hudson).</p>

<p>First of all and against all odds, TDD is fun! I swear, I really enjoy it. And adding Jenkins multiply the fun because you can gloat, showing off you 100% test coverage, your sky-rocketing test count, etc.</p>

<p>Now, I wouldn&#8217;t write a post just to say TDD is fun. Anyway TDD becomes fun and worthy of the effort when you have figured out some quirks of the different tools.</p>

<p>PHPUnit is a pain in the a**. But it seems to be the de facto standard so&#8230; I&#8217;m waiting for a stable version of <a href='http://blog.mageekbox.net/?category/Projets/atoum'>Atoum</a> though.</p>

<p>I got 3 major issues with PHPUnit:</p>

<p>1- On a previous project, I found out the process isolation support is incomplete. To have a real process isolation, you have to put your tests in separate files! And it is really long to run the complete test suite. So you&#8217;ve got 3 options: multiply the file count of your project, curse PHPUnit&#8217;s author or rewrite your project and stop using constants for everything&#8230;</p>

<p>2- Namespace support is weird, especially when using type hinting of classes. My advice: use full-qualified names. Not a big deal, you SHOULD always use full-qualified names anyway. That way, your fellow developer will not have to learn the whole namespace hierarchy to understand your code.</p>

<p>3- Mocks are cool but they&#8217;re not meant to fix all your problems. You want to test if an object&#8217;s method is called: mocks are the solution. You want to make sure that during a future rewrite your fellow developer will not forget to update the client class of another? Use a real instance of the object, not a mock of it. Here&#8217;s a stupid example:</p>

<pre><code>class Conf
{
    public function get_conf($key)
    {
        //do something
    }

    public function set_conf($key,$value)
    {
        //do something
    }
}

class Client
{
    public function __construct(Conf $conf)
    {
        $conf_entry = $conf-&gt;get_conf(&#39;key&#39;);
        $conf-&gt;set_conf(&#39;key2&#39;,&#39;value2&#39;);
        $conf_entry_2 = $conf-&gt;get_conf(&#39;key2&#39;);
        if($conf_entry_2 === false)
        {
             throw new Exception();
        }
    }
}</code></pre>

<p>To make sure the <code>get_conf</code> method is called by <code>Client</code>&#8217;s constructor, use a mock.<br />To make sure the exception is thrown if <code>$conf_entry_2</code> is empty, use an instance of <code>Conf</code>. Why?<br />Because someday, <code>Conf</code> may return <code>null</code> instead of <code>false</code> after a rewrite. The <code>Conf</code> unit tests will be changed and the developer will be happy, he&#8217;s got 100% passed tests. But the <code>Client</code> class has not been changed because you&#8217;ve mocked <code>Conf</code> to return false. The tests are passing but the developer didn&#8217;t rewrite <code>Client</code> to test <code>$conf_entry_2</code> against <code>null</code> instead of <code>false</code>.</p>

<p>I&#8217;ve also got an issue using autoloading with namespaces. I&#8217;m not sure it&#8217;s related to PHPUnit but anyway&#8230; I liked the solution I found because it will prevent some possible code collision which is the main benefit of namespaces in the first place. The solution? Instead of naming your autoload function <code>__autoload()</code>, use a specific and very unique name such as <code>myFantasticAutoloadingFunctionThatKicksAss()</code> and use the <code>spl_autoload_register()</code> function to register it as an autoload function. After that PHPUnit was able to find my classes by himself.</p>

<p>Now TDD is starting to be fun.</p>

<p>PS: I will update this page if I find other quirks.</p>

<p><strong>Update:</strong></p>

<p>I&#8217;ve got 2 new quick tips:</p>

<ul>
<li>I use Netbeans to code and it is really simple to have a split screen in Netbeans. Just drag the file tab you want to split to the right and you&#8217;ll have a split screen. Really handy for TDD to write your test and your code side by side.</li>

<li>I found out that mocking 2 consecutive calls to the same method is not explained in PHPUnit&#8217;s documentation. But it&#8217;s simple: instead of using <code>once()</code>, <code>any()</code> or <code>none()</code> in <code>expects()</code>, use <code>at(0)</code> for the first call and <code>at(1)</code> in the second and so on. You can even make the mock return different values each time. I needed this in my previous example because you usually retrieve configuration more than once.</li>
</ul>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'simonjodet';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

            </div>
            <div class="span4 columns offset1">
                <div class="page-header">
                    <h3>
                        <a href="http://twitter.com/intent/user?screen_name=simonjodet" target="_blank" class="twitter_follow_link" id="twitter-link"><img src="/style/twitter_bird.png" class="twitter_bird_icon"/>&nbsp;Twitter feed</a>
                        <div class="twipsy below tooltips" id="twitter-tooltip"> 
                            <div class="twipsy-arrow"></div> 
                            <div class="twipsy-inner">Follow me on Twitter!</div> 
                        </div>
                    </h3>
                </div>
                <div class="tweet"></div>
                
            </div>
        </div>
    </div>
    <div class="container footer">
        Copyright &copy; 2011 Simon Jodet - All rights reserved
    </div>
    <script src="/lib/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="/lib/jquery.tweet.js" type="text/javascript" charset="utf-8"></script>
    <script src="/scripts.js" type="text/javascript" charset="utf-8"></script>
</body>
</html>
